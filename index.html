<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daylight Scheduler - Year Overview</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    header {
      padding: 20px;
      background: #333;
      color: #fff;
      text-align: center;
    }

    .controls {
      padding: 10px;
      background: #f0f0f0;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .grid-container {
      /* This container centers the entire grid and gives it a border */
      width: calc(100px + (24 * 40px));
      /* 24 hours * 40px/hour = 960px + 100px label column = 1060px total */
      margin: 20px auto;
      border: 1px solid #ccc;
      background: #2c3e50;
      overflow: hidden;
      position: relative;
    }

    /* Hours header row */
    .hours-header {
      position: relative;
      height: 40px;
      border-bottom: 1px solid #ccc;
      background: #ddd;
      overflow: hidden; /* no horizontal scroll, fixed width now */
      white-space: nowrap;
    }

    .hours-header-content {
      position: absolute;
      left: 100px; /* after month labels */
      top: 0;
      height: 100%;
    }

    .hour-label {
      display: inline-block;
      width: 40px; /* width per hour */
      text-align: center;
      line-height: 40px;
      font-size: 12px;
      color: #333;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
    }

    /* Container with months */
    .months-container {
      position: relative;
      overflow: hidden;
      white-space: nowrap; /* Keep hours in one line */
    }

    /* Each month row */
    .month-row {
      position: relative;
      height: 60px;
      border-bottom: 1px solid #444;
    }

    .month-label {
      position: absolute;
      left: 0;
      top: 0;
      width: 100px;
      height: 100%;
      background: #eee;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border-right: 1px solid #ccc;
      z-index: 2;
    }

    .month-hours {
      position: absolute;
      left: 100px;
      top: 0;
      height: 100%;
      white-space: nowrap;
    }

    .month-hour {
      display: inline-block;
      width: 40px; /* same as hour-label width */
      height: 100%;
      position: relative;
      box-sizing: border-box;
    }

    /* Night/day overlay per month row */
    .night-overlay {
      pointer-events: none;
      position: absolute;
      top: 0;
      left: 100px;
      height: 100%;
      z-index: 1;
    }

    /* Single Work block - spans all months */
    .work-block {
      position: absolute;
      top: 40px; /* below the hours header */
      left: 100px; /* initial offset after month labels */
      height: calc(60px * 12); /* cover all 12 rows */
      background: rgba(39, 174, 96, 0.7);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      border-radius: 4px;
      cursor: grab;
      z-index: 3;
    }

    .work-block:active {
      cursor: grabbing;
    }

    .info {
      text-align: center;
      margin: 10px;
      font-size: 14px;
    }

    .read-only-field {
      width: 150px;
      padding: 5px;
      border: 1px solid #ccc;
      background: #eee;
      text-align: center;
    }
  </style>
</head>
<body>

  <header>
    <h1>Daylight Scheduler - Year Overview</h1>
    <p>Drag the "Work" block to choose working hours for the entire year.</p>
  </header>

  <div class="controls">
    <input type="text" id="latitude" placeholder="Latitude" value="40.7128" style="width:100px;">
    <input type="text" id="longitude" placeholder="Longitude" value="-74.0060" style="width:100px;">
    <button id="fetchBtn">Fetch Sunrise/Sunset</button>
    <label>Work Duration (hours):</label>
    <input type="number" id="workDuration" min="1" max="24" value="8" style="width:50px;">
    <label>Work Hours:</label>
    <input type="text" id="workHoursDisplay" class="read-only-field" readonly>
  </div>

  <div class="grid-container">
    <!-- Hours header row -->
    <div class="hours-header" id="hoursHeader">
      <div class="hours-header-content" id="hoursHeaderContent">
        <!-- Hours generated by JS -->
      </div>
    </div>

    <!-- Container with months -->
    <div class="months-container" id="monthsContainer">
      <!-- Month rows generated by JS -->
    </div>

    <!-- Single work block -->
    <div class="work-block" id="workBlock">
      Work
    </div>
  </div>

  <div class="info">
    <p>Hours run horizontally (0 to 23). Each hour = 40px. Drag the "Work" block to shift the schedule.</p>
  </div>

  <script>
    const HOURS = 24;
    const HOUR_WIDTH = 40;
    const MONTHS = [
      'January','February','March','April','May','June',
      'July','August','September','October','November','December'
    ];

    const hoursHeader = document.getElementById('hoursHeaderContent');
    const monthsContainer = document.getElementById('monthsContainer');
    const workBlock = document.getElementById('workBlock');
    const fetchBtn = document.getElementById('fetchBtn');
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    const workDurationInput = document.getElementById('workDuration');
    const workHoursDisplay = document.getElementById('workHoursDisplay');

    let workStartHour = 0; // initial start hour
    let workDuration = parseInt(workDurationInput.value, 10) || 8;

    // Generate hours in header
    for (let h = 0; h < HOURS; h++) {
      const hourDiv = document.createElement('div');
      hourDiv.className = 'hour-label';
      hourDiv.textContent = h;
      hoursHeader.appendChild(hourDiv);
    }
    hoursHeader.style.width = (HOURS * HOUR_WIDTH) + 'px';

    // Generate months rows
    MONTHS.forEach((m, i) => {
      const monthRow = document.createElement('div');
      monthRow.className = 'month-row';
      monthRow.setAttribute('data-month', i);
      monthsContainer.appendChild(monthRow);

      const labelDiv = document.createElement('div');
      labelDiv.className = 'month-label';
      labelDiv.textContent = m;
      monthRow.appendChild(labelDiv);

      const monthHours = document.createElement('div');
      monthHours.className = 'month-hours';
      monthHours.style.width = (HOURS * HOUR_WIDTH) + 'px';
      for (let h = 0; h < HOURS; h++) {
        const mhDiv = document.createElement('div');
        mhDiv.className = 'month-hour';
        monthHours.appendChild(mhDiv);
      }
      monthRow.appendChild(monthHours);

      // Night overlay
      const nightOverlay = document.createElement('div');
      nightOverlay.className = 'night-overlay';
      nightOverlay.style.width = (HOURS * HOUR_WIDTH) + 'px';
      monthRow.appendChild(nightOverlay);
    });

    // Set initial work block width based on duration
    function updateWorkBlockWidth() {
      workBlock.style.width = (workDuration * HOUR_WIDTH) + 'px';
    }
    updateWorkBlockWidth();

    // Update displayed start/end times
    function updateWorkHoursDisplay() {
      // Start hour = workStartHour
      const endHour = (workStartHour + workDuration) % 24;
      workHoursDisplay.value = `${formatHour(workStartHour)}:00 - ${formatHour(endHour)}:00`;
    }

    function formatHour(h) {
      return h.toString().padStart(2, '0');
    }

    updateWorkHoursDisplay();

    // Make work block draggable horizontally
    let isDragging = false;
    let dragStartX = 0;
    let initialLeft = 0;

    workBlock.addEventListener('mousedown', (e) => {
      e.preventDefault();
      isDragging = true;
      dragStartX = e.clientX;
      initialLeft = parseInt(workBlock.style.left, 10) || 100;
      document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const diff = e.clientX - dragStartX;
      let newLeft = initialLeft + diff;
      // Constrain within total width (24 hours)
      const maxLeft = 100 + (HOURS * HOUR_WIDTH) - parseInt(workBlock.style.width,10);
      if (newLeft < 100) newLeft = 100;
      if (newLeft > maxLeft) newLeft = maxLeft;
      workBlock.style.left = newLeft + 'px';

      // Calculate start hour based on position
      const startPx = newLeft - 100;
      workStartHour = Math.round(startPx / HOUR_WIDTH);
      updateWorkHoursDisplay();
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        document.body.style.userSelect = 'auto';
      }
    });

    workDurationInput.addEventListener('change', () => {
      workDuration = parseInt(workDurationInput.value, 10) || 8;
      if (workDuration < 1) workDuration = 1;
      if (workDuration > 24) workDuration = 24;
      workDurationInput.value = workDuration;
      updateWorkBlockWidth();

      // Adjust if block exceeds boundary after width change
      const currentLeft = parseInt(workBlock.style.left, 10) || 100;
      const maxLeft = 100 + (HOURS * HOUR_WIDTH) - parseInt(workBlock.style.width,10);
      let newLeft = currentLeft;
      if (newLeft > maxLeft) newLeft = maxLeft;
      workBlock.style.left = newLeft + 'px';

      // Recalculate start hour
      const startPx = newLeft - 100;
      workStartHour = Math.round(startPx / HOUR_WIDTH);
      updateWorkHoursDisplay();
    });

    fetchBtn.addEventListener('click', () => {
      fetchAllMonths(latInput.value, lngInput.value);
    });

    // Fetch sunrise/sunset for each month (e.g., on the 15th)
    async function fetchAllMonths(lat, lng) {
      const promises = MONTHS.map((m, i) => {
        const date = `${(new Date().getFullYear())}-${String(i+1).padStart(2,'0')}-15`;
        return fetchSunData(lat, lng, date).then(data => ({monthIndex: i, data}));
      });

      const results = await Promise.all(promises);

      results.forEach(r => {
        const monthRow = monthsContainer.querySelector(`.month-row[data-month="${r.monthIndex}"]`);
        if (r.data && monthRow) {
          updateDaylightOverlay(monthRow, r.data.sunriseHourLocal, r.data.sunsetHourLocal);
        }
      });
    }

    async function fetchSunData(lat, lng, date) {
      const url = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&date=${date}&formatted=0`;
      const res = await fetch(url);
      if (!res.ok) return null;
      const json = await res.json();
      if (json.status !== 'OK') return null;

      const sunrise = new Date(json.results.sunrise);
      const sunset = new Date(json.results.sunset);

      // Convert to local hour
      const offset = (new Date()).getTimezoneOffset() / 60;
      const localSunriseHour = (sunrise.getUTCHours() - offset + 24) % 24;
      const localSunsetHour = (sunset.getUTCHours() - offset + 24) % 24;

      return {
        sunrise,
        sunset,
        sunriseHourLocal: localSunriseHour,
        sunsetHourLocal: localSunsetHour
      };
    }

    function updateDaylightOverlay(monthRow, srHour, ssHour) {
      const nightOverlayEl = monthRow.querySelector('.night-overlay');
      const srPercent = (srHour / 24) * 100;
      const ssPercent = (ssHour / 24) * 100;

      nightOverlayEl.style.background = `linear-gradient(to right,
        rgba(0,0,0,0.4) 0%,
        rgba(0,0,0,0.4) ${srPercent}%,
        rgba(0,0,0,0) ${srPercent}%,
        rgba(0,0,0,0) ${ssPercent}%,
        rgba(0,0,0,0.4) ${ssPercent}%,
        rgba(0,0,0,0.4) 100%
      )`;
    }

    // Initial fetch
    fetchAllMonths(latInput.value, lngInput.value);
  </script>

</body>
</html>

